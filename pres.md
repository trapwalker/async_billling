
# Асинхронный биллинг

Концепия строится на потоке *Событий* и связанном с ним потоке *Состояний*.

*Клиент* - учетная запись получателя услуг.

*Услуга* - атомарная опция, предоставляема компанией клиенту на возмездной 
или безвозмездной основе согласно *Тарифу*

*Тариф* - набор условий и правил списания средств со *Счетов* *Клиента* за предоставляемые услуги.

*Счет* - реальный (финансовый дебетовый в определённой валюте) или формальный
(бонусный, вспомогательный в произвольных едницах измерения) счет, для дискретных или 
пропорциональных списаний. 
В составе *Состояния* характеризуется значением на момент времени (V) и скоростью расхода (dV).

---

# Состояние

Неизменяемая запись в цепочке *Состояний* *Клиента*, порождаемая *Событием*.

*Состояние* актуально с момента его наступления включительно (таймштамп) 
и до момента наступления следующего в цепочке состояния (исключительно).

#### Атрибуты *Состояния*:

- Настройки и параметры услуг и тарифов.
- Событие, послужившее причиной обновления состояния.
- Таймштамп - момент в потоке ламинарного времени.
- Счета клиента (может быть несколько):
    - реальные (разные валюты, разные плательщики, дебетные/кредитные)
    - формальные (бонусы, тарифные гигабайты, тарифные минуты GPU)

#### Атрибуты *Счета*:

- техническое название
- единицы измерения
- значение (V)
- расход (dV)
- прогнозируемый на основе статистики расход (~dV)
    
---

# События

События можно разделить на два вида:
1. Внезапные
1. Плановые

---

# Внезапные события:

Это события, которые нельзя предсказать, они происходят по внешнему сигналу: 
- из пользовательского интерфейса
- из потока событий, свзанных с метриками и статистикой
- из API от внешних систем

Обычно такие события происходят *в реальном времени*, но технически они могут быть инициированы "задним числом" или 
запланированы на определённый момент в будущем.

#### Примеры:
- Создание/удаление аккаунта.
- Изменение конфигурации клиента (перечень услуг, тарифов, счетов).
- Пауза/возобновление предоставления услуги.
- Изменение Состояния для фиксации ошибок.
- Пополнение дебетового счета или административное начисление бонусов.
- Приход статистики (списание средств за использованные ресурсы). 

---

# Плановые события:

Это события, которые предусмотрены внутренними правилами и алгоритмами Системы, 
определяются логикой работы тарифов и конфигурацией Клиента.

Вычисляются на основе актуального Состояния. 
Имеет значение только ближайшее по времени плановое событие.

#### Примеры
- Плановый Снапшот.
- Плановая смена условий тарифа (тестовый период; день/ночь).
- Окончание срока действия тарифа.
- Дискретное списание абон-платы.
- Обновление формального (бонусного) счета.
- Списание средств с карты (плановая попытка).
- Обнуление счета (по dV).
- Предупреждение о низком балансе (по dV).
- Выставление инфвойса.

---

# Операционный лаг

События, приходящие в систему в реальном времени могут быть немного рассогласованы
по времени и попадать в таймлайн не в хронологическом порядке.
Другими словами, какой-то из источников может работать с запаздыванием.

Внедрение события в цепочку событий создаёт новые состояния между уже суествующими.

Добавление такого события "задним числом" неизбежно приведёт к инвалидации и 
пересчету всех состояний после этого события. 

Это не является проблемой, поскольку фактическое время добавления состояния и 
его номинальный таймштамп фиксируются внутри события. 

Ошибочные события можно инвалидировать задним чмслом с пересчетом состояний за любой период.

Единственный важный здесь нюанс - это внешние артефакты, сообщения и управляющие сигналы.

Отправлять пользователю письма и уведомления нужно за пределами окна Операционного Лага.
Например, на расстоянии 3*sigma от мат-ожидания заднего фронта этого окна. 

---

# Благодарности


<img src="cat.jpg" alt="drawing" width="750"/>